box: danmaq/jekyll-git-redcarpet:github-pages
build:
  steps:
    - script:
        name: まず GitHub に SSH で繋ぐために必要な秘密鍵の設定やるよー
        code: |
          cd ~
          echo ${PRIVATE_KEY} | sed 's/\\n/\n/g' > .ssh/id_rsa
          chmod 600 .ssh/id_rsa
    - script:
        name: そうそう、 Git のユーザー設定もしなきゃね！
        code: |
          init.sh
    - script:
        name: 準備おっけー？ GitHub から記事リポジトリをクローンするよ！
        code: |
          cd /tmp/
          git clone git@github.com:danmaq/danmaq.articles.git
    - script:
        name: 次に GitHub からテーマリポジトリもクローンするよ！
        code: |
          cd /tmp/
          git clone git@github.com:danmaq/danmaq.jekyll.git
    - script:
        name: いい感じっ！クローンしたデータを作業台に載せるよ！
        code: |
          cp -r /tmp/danmaq.articles/root/* /srv/jekyll
          cp -r /tmp/danmaq.articles/_posts /srv/jekyll
          cd /srv/jekyll
    - script:
        name: 成果物を作るよ！Jekyll さん、ビルドお願いっ！
        code: jekyll b
    - script:
        name: やったー！じゃあ今度は、成果物を入れるリポジトリもクローンしようね！
        code: |
          cd /tmp/
          git clone git@github.com:danmaq/danmaq.github.io.git
    - script:
        name: 受け皿ができた感じ。じゃあ成果物を入れちゃおうね！
        code: cp -r /srv/jekyll/_site/* /tmp/danmaq.github.io/
    - script:
        name: 最後の仕上げだよ！新しい成果物を確定しちゃおう！
        code: |
          cd /tmp/danmaq.github.io
          git add -A
          git commit -m 'Converted from danmaq/danmaq.articles:master'
          git push
